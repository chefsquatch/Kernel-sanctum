<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kernel AI – All Features Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* — your existing CSS exactly as before — */
    body { background:#1c222b; color:#e3ffe9; font-family:Inter,sans-serif; margin:0; }
    /* … copy all your CSS from .kernel-container through @media … */
  </style>
</head>
<body>
  <div class="kernel-container" id="kernel-app">
    <div class="header">
      <img src="https://api.dicebear.com/8.x/bottts-neutral/svg?seed=kernel"
           class="avatar" alt="Kernel AI" />
      <span class="title">Kernel AI</span>
      <button id="settingsBtn" class="settings-btn">&#9881;</button>
    </div>

    <div class="features-bar">
      <button id="learnBtn" class="feature-btn">Learn</button>
      <div id="loadingSpinner" class="loading-spinner"></div>
    </div>

    <div id="chatbox" class="chatbox"></div>

    <form id="chat-form" class="input-row">
      <input id="input" autocomplete="off" placeholder="Type a message…" />
      <button type="submit" class="send-btn">Send</button>
    </form>
  </div>

  <div id="settingsModal" class="settings-modal">
    <div class="settings-box">
      <button id="closeSettings" class="settings-close">&times;</button>
      <h3>Settings</h3>
      <label>
        API Key:
        <input id="apiKeyInput" type="password" placeholder="OpenAI API Key" />
      </label>
      <label>
        Mode:
        <select id="modeSelect">
          <option value="offline">Offline</option>
          <option value="online">Online (API)</option>
        </select>
      </label>
      <button id="saveSettings" class="feature-btn">Save</button>
    </div>
  </div>

  <script type="module">
    import {
      sendKernelMessage,
      learnSubject,
      saveApiKey,
      getApiKey,
      setMode
    } from './src/KernelEngine.js';

    const chatbox       = document.getElementById('chatbox');
    const spinner       = document.getElementById('loadingSpinner');
    const inputField    = document.getElementById('input');
    const settingsModal = document.getElementById('settingsModal');

    let messages = [{ kernel: 'Welcome! How can I help you today?' }];

    function renderChat() {
      chatbox.innerHTML = '';
      for (const m of messages) {
        if (m.user)   chatbox.innerHTML += `<div class="user-msg">${m.user}</div>`;
        if (m.kernel) chatbox.innerHTML += `<div class="kernel-msg">${m.kernel}</div>`;
      }
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    renderChat();

    document.getElementById('chat-form').onsubmit = async e => {
      e.preventDefault();
      const text = inputField.value.trim();
      if (!text) return;
      messages.push({ user: text });
      renderChat();
      inputField.value = '';
      spinner.style.display = 'inline-block';

      await sendKernelMessage(text, reply => {
        messages.push({ kernel: reply });
        renderChat();
        spinner.style.display = 'none';
      });
    };

    document.getElementById('learnBtn').onclick = async () => {
      const subj = prompt('What subject should I learn?');
      if (!subj) return;
      messages.push({ user: `learn subject: ${subj}` });
      renderChat();
      spinner.style.display = 'inline-block';

      const reply = await learnSubject(subj)
        .catch(() => 'Oops, something went wrong while learning.');
      messages.push({ kernel: reply });
      renderChat();
      spinner.style.display = 'none';
    };

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      settingsModal.classList.add('active');
      document.getElementById('apiKeyInput').value = getApiKey();
    };
    document.getElementById('closeSettings').onclick = () => {
      settingsModal.classList.remove('active');
    };
    document.getElementById('saveSettings').onclick = e => {
      e.preventDefault();
      saveApiKey(document.getElementById('apiKeyInput').value);
      setMode(document.getElementById('modeSelect').value);
      settingsModal.classList.remove('active');
      messages.push({ kernel: 'Settings updated.' });
      renderChat();
    };
  </script>
</body>
</html>